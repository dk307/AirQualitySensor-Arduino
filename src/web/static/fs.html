<!DOCTYPE html>
<html lang="en-US">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="shortcut icon" href="media/favicon.png" type="image/x-icon">
  <link rel="icon" href="media/favicon.png" type="image/x-icon">
  <title>SD Card</title>

  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.15.2/css/all.css" />
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/5.1.3/css/bootstrap.min.css" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-dark-5@1.1.3/dist/css/bootstrap-nightfall.min.css" rel="stylesheet"
    media="(prefers-color-scheme: dark)">
  <link rel="stylesheet" href="https://cdn.datatables.net/v/bs5/dt-1.13.1/r-2.4.0/datatables.min.css" />

</head>

<body>

  <div class="container py-4">
    <div class="row py-1">
      <div class="col px-1 align-self-start">
        <h3 class="mb-5" id="location">Files</h3>
      </div>
      <div class="col align-self-end d-flex justify-content-end">
        <button type="button" class="btn btn-info" id="uploadButtonId">Upload</button>
      </div>
    </div>
    <div class="row">
      <div class="col-12">
        <table id="fs" class="table table-striped dt-responsive nowrap" style="width:100%">
          <thead>
            <tr>
              <th>Name</th>
              <th>Size(Bytes)</th>
              <th>Last Modified</th>
              <th></th>
            </tr>
          </thead>
        </table>
      </div>
    </div>
  </div>

  <!-- Confirm Delete Modal Start-->
  <form id="deleteActionForm" method="post">
    <div class="modal fade" id="deleteActionModal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1"
      aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Confirm</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>

          <div class="modal-body">
            <div class="mb-4">
              <span class="justify-left">Do you want to delete </span>
              <span class="justify-left" id="deleteFileName"></span>
              <span class="justify-left">?</span>
            </div>

            <div class="mb-4">
              <div class="text-danger" id="deleteActionStatus"></div>
            </div>

            <input type="hidden" id="filePath">
          </div>

          <div class="modal-footer">
            <button type="submit" class="btn btn-danger">Delete</button>
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          </div>
        </div>
      </div>
    </div>
  </form>
  <!-- Confirm Delete Modal End -->


  <!-- Rename Modal -->
  <form id="renameActionForm" method="post">
    <div class="modal fade" id="renameModal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1"
      role="dialog" aria-labelledby="renameModalLabel" aria-hidden="true">
      <div class="modal-dialog" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="renameModalLabel">Rename</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <div class="form-group">
              <label for="renameFileName">Rename to:</label>
              <input type="text" class="form-control" id="renameFileName">
            </div>

            <div class="mb-4">
              <div class="text-danger" id="renameActionStatus"></div>
            </div>

            <input type="hidden" id="renameFilePath">
          </div>
          <div class="modal-footer">
            <button type="submit" class="btn btn-primary" id="confirmRename">Rename</button>
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          </div>
        </div>
      </div>
    </div>
  </form>

  <!-- File Update Modal Start-->
  <form class="needs-validation" id="fileUploadUploadForm" method="post" enctype="multipart/form-data">
    <div class="modal fade" id="fileUploadUpdateModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="fileUploadUpdateModalLabel">Select File</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>

          <div class="modal-body">
            <div class="mb-1">
              <div>Select file for upload</div>
            </div>
            <div class="mb-4">
              <input class="form-control" id="fileUploadFileUploadId" type="file" name="fileUploadFileUploadId"
                required />
            </div>

            <input type="hidden" id="uploadDirFilePath">

            <div class="mb-4" id="fileUploadUploadStatusWrapper">
              <div>Upload Status:</div>
              <div class="progress" style="height: 15px;">
                <div id="fileUploadUploadProgressBar" class="progress-bar" role="progressbar" style="width: 0%;"></div>
              </div>
              <div id="fileUploadUploadStatus"></div>
            </div>
          </div>
          <div class="modal-footer">
            <button class="btn btn-primary" id="fileUploadButton">Upload</button>
            <button class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          </div>
        </div>
      </div>
    </div>
  </form>
  <!-- File update Modal End -->

  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/5.1.3/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.datatables.net/v/bs5/dt-1.13.1/r-2.4.0/datatables.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.20.1/moment.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/spark-md5/3.0.2/spark-md5.min.js"></script>

  <script>
    function getURLParameter(sParam) {
      var sPageURL = window.location.search.substring(1);
      var sURLVariables = sPageURL.split('&');
      for (var i = 0; i < sURLVariables.length; i++) {
        var sParameterName = sURLVariables[i].split('=');
        if (sParameterName[0] == sParam) {
          return sParameterName[1];
        }
      }
    }

    var dir = getURLParameter("dir");
    if (typeof dir === "undefined" || dir === null || dir.match(/^ *$/) !== null) {
      dir = "/";
    }

    $("#location").html(dir);


    var dataSet = [{ "isDir": false, "name": "config.json", "size": 230, "lastModified": 1675014070 },
    { "isDir": false, "name": "config_checksum.json", "size": 132, "lastModified": 1675014070 },
    { "isDir": false, "name": "config_checksum.json", "size": 322, "lastModified": 1675014070 },
    { "isDir": false, "name": "config_checksum.json", "size": 32, "lastModified": 1675014070 },
    { "isDir": true, "name": "System Volume Information", "size": 0, "lastModified": 1670008324 },
    { "isDir": true, "name": "display", "size": 0, "lastModified": 1672932418 },
    { "isDir": true, "name": "display2", "size": 0, "lastModified": 167292418 },
    { "isDir": true, "name": "display2", "size": 0, "lastModified": 167292418 },
    { "isDir": true, "name": "display2", "size": 0, "lastModified": 167292418 },
    { "isDir": true, "name": "display2", "size": 0, "lastModified": 367292418 },
    { "isDir": true, "name": "display2", "size": 0, "lastModified": 16729248 },
    { "isDir": true, "name": "display2", "size": 0, "lastModified": 167292418 },
    { "isDir": true, "name": "display2", "size": 0, "lastModified": 167292418 },
    { "isDir": true, "name": "display2", "size": 0, "lastModified": 167292418 },
    { "isDir": true, "name": "web", "size": 0, "lastModified": 1674331370 }];

    $('#fs').DataTable({
      // ajax: {
      //   url: "/fs/list?dir=" + dir,
      //   type: "GET"
      // },
      data: dataSet,
      responsive: true,
      columns: [
        {
          data: "name",
          responsivePriority: 1,
          render: function (data, type, row, meta) {
            if (row["isDir"]) {
              data = '<a href="/fs.html?dir=' + encodeURIComponent(data) + '">' + data + '</a>';
            } else {
              data = '<a href="/fs/download?path=' + encodeURIComponent(data) + '">' + data + '</a>';
            }
            return data;
          }
        },
        {
          data: "size",
          responsivePriority: 2,
          render: function (data, type, row, meta) {
            if (row["isDir"]) {
              return "";
            }
            return data;
          }
        },
        {
          data: "lastModified",
          responsivePriority: 3,
          render: function (data, type, full, meta) { return moment.unix(data).fromNow(); }
        },
        {
          responsivePriority: 1,
          orderable: false,
          data: null,
          render: function (data, type, row, meta) {
            var name = row["name"];
            var fullPath = dir + "/" + name;
            return "<a class='btn btn-secondary' onclick='deleteNode(\"" + fullPath + "\", \"" + name + "\");'><i class='fas fa-trash'></i></a>" +
              "&nbsp;<a href='#'class='btn btn-secondary' onclick='renameNode(\"" + fullPath + "\", \"" + name + "\");'><i class='fas fa-edit'Rename</i></a>";
          }
        }
      ]

    });

    $("#deleteActionForm").on('submit', function (e) {
      e.preventDefault();
      var form = $('#deleteActionForm');

      $.ajax({
        type: form.attr('method'),
        url: form.attr('action'),
        data: new FormData(this),
        contentType: false,
        cache: false,
        processData: false,
        beforeSend: function () {
          $('#deleteActionStatus').hide();
        },
        error: function (jqXHR, textStatus, errorThrown) {
          if (jqXHR.status == 500) {
            $('#deleteActionStatus').text(jqXHR.responseText);
          } else {
            $('#deleteActionStatus').text('Delete operation failed');
          }
          $('#deleteActionStatus').show();
        },
        success: function (resp) {
          $('#deleteActionModal').modal('hide');
        }
      });
    });


    function deleteNode(filePath, name) {
      var url = "/fs/delete";
      $('#filePath').val(filePath);
      $('#deleteFileName').text(name);
      $('#deleteActionForm').attr('action', url);
      $('#deleteActionStatus').hide();
      $('#deleteActionModal').modal('show');
    }

    function renameNode(filePath, name) {
      var url = "/fs/rename";
      $('#renameFilePath').val(filePath);
      $('#renameFileName').val(name);
      $('#renameActionForm').attr('action', url);
      $('#renameActionStatus').hide();
      $('#renameModal').modal('show');
    }

    $("#renameActionForm").on('submit', function (e) {
      e.preventDefault();
      var form = $('#renameActionForm');

      $.ajax({
        type: form.attr('method'),
        url: form.attr('action'),
        data: new FormData(this),
        contentType: false,
        cache: false,
        processData: false,
        beforeSend: function () {
          $('#renameActionStatus').hide();
        },
        error: function (jqXHR, textStatus, errorThrown) {
          if (jqXHR.status == 500) {
            $('#renameActionStatus').text(jqXHR.responseText);
          } else {
            $('#renameActionStatus').text('Rename operation failed');
          }
          $('#renameActionStatus').show();
        },
        success: function (resp) {
          $('#renameModal').modal('hide');
        }
      });
    });

    // File upload via Ajax
    $("#fileUploadUploadForm").on('submit', function (e) {
      e.preventDefault();
      var form = $('#fileUploadUploadForm');
      $.ajax({
        xhr: function () {
          var xhr = new window.XMLHttpRequest();
          xhr.upload.addEventListener("progress", function (evt) {
            if (evt.lengthComputable) {
              var percentComplete = ((evt.loaded / evt.total) * 100).toFixed();
              $("#fileUploadUploadProgressBar").width(percentComplete + '%');
              $("#fileUploadUploadProgressBar").html('<span class="text-center">' + percentComplete + '%</span>');
            }
          }, false);
          return xhr;
        },
        type: form.attr('method'),
        url: form.attr('action'),
        data: new FormData(this),
        contentType: false,
        cache: false,
        processData: false,
        headers: { 'md5': fileUploadFileUploadMd5 },
        beforeSend: function () {
          $("#fileUploadUploadProgressBar").width('0%');
          $('#fileUploadUploadStatus').html('');
          $("#fileUploadUploadStatusWrapper").show();
          $('#fileUploadButton').hide();
        },
        error: function (jqXHR, textStatus, errorThrown) {
          if (jqXHR.status == 500) {
            $('#fileUploadUploadStatus').html('<div class="text-danger" id="fileUploadUpgradeError"></div>');
            $('#fileUploadUpgradeError').text(jqXHR.responseText);
          } else {
            $('#fileUploadUploadStatus').html('<div class="text-danger">File upload failed, please try again.</div>');
          }
          $('#fileUploadButton').show();
        },
        success: function (resp) {
          $('#fileUploadUpdateModal').modal('hide');
        }
      });
    });

    // md5
    document.getElementById('fileUploadFileUploadId').addEventListener('change', function () {

      $('#fileUploadUploadStatus').html('');
      $("#fileUploadUploadStatusWrapper").hide();

      var blobSlice = File.prototype.slice || File.prototype.mozSlice || File.prototype.webkitSlice,
        file = this.files[0],
        chunkSize = 1024 * 1024,
        chunks = Math.ceil(file.size / chunkSize),
        currentChunk = 0,
        spark = new SparkMD5.ArrayBuffer(),
        fileReader = new FileReader();

      fileReader.onload = function (e) {
        spark.append(e.target.result);
        currentChunk++;

        if (currentChunk < chunks) {
          loadNext();
        } else {
          fileUploadFileUploadMd5 = spark.end();
          console.info('computed hash', fileUploadFileUploadMd5);
        }
      };

      fileReader.onerror = function () {
        console.warn('oops, something went wrong.');
      };

      function loadNext() {
        var start = currentChunk * chunkSize,
          end = ((start + chunkSize) >= file.size) ? file.size : start + chunkSize;

        fileReader.readAsArrayBuffer(blobSlice.call(file, start, end));
      }
      loadNext();
    });

    document.getElementById('uploadButtonId').addEventListener('click', function () {
      $('#uploadDirFilePath').val(dir);
      $('#fileUploadUploadForm').attr('action', '/fs/upload');
      $("#fileUploadUploadStatusWrapper").hide();
      $('#fileUploadButton').show();
      $('#fileUploadUpdateModal').modal('show');
   });

  </script>
</body>

</html>